class Quiz{constructor(t){this.quiz=t,this.url="/assets/components/quiz/action.php",this.csrf=this.quiz.querySelector('input[name="csrf_token"]').value,this.form=this.quiz.querySelector("form"),this.cover=this.quiz.querySelector(".quiz-cover"),this.steps=this.quiz.querySelector(".quiz-steps"),this.startBtn=this.quiz.querySelector(".quiz-start"),this.buttons=this.quiz.querySelector(".quiz-actions"),this.prevBtn=this.quiz.querySelector(".quiz-prev"),this.nextBtn=this.quiz.querySelector(".quiz-next"),this.submitBtn=this.quiz.querySelector(".quiz-submit"),this.classValid="is-valid",this.classInvalid="is-invalid",this.addEventListeners(),this.reset()}addEventListeners(){this.startBtn?.addEventListener("click",this.next.bind(this)),this.prevBtn?.addEventListener("click",this.prev.bind(this)),this.nextBtn?.addEventListener("click",this.next.bind(this)),this.submitBtn?.addEventListener("click",this.submit.bind(this)),this.form.addEventListener("change",({target:t})=>{t.classList.contains("quiz-change")&&this.clearFormError(t)}),this.form.addEventListener("input",({target:t})=>{t.classList.contains("quiz-change")||this.clearFormError(t)})}async updateTotal(t){t?(this.total=t,this.updateButtons()):(t=await this.fetch("total")).success&&(this.total=t.total,this.updateButtons())}updateSection(){this.sections=Array.from(this.quiz.querySelectorAll(".quiz-section"))}hideSections(){this.sections.forEach(t=>{t.style.display="none"})}async next(){this.startBtn&&(this.startBtn.disabled=!0),this.nextBtn.disabled=!0;var t=this.getCurrentSection(),t=(t&&t.querySelectorAll(".quiz-change").forEach(t=>{t.disabled=!1}),await this.fetch("step"));await this.response(t)}prev(){var t;0<this.current&&(this.getCurrentSection().remove(),this.current--,this.showCurrentSection(),this.updateTotal(this.total),t=this.getCurrentSection())&&t.querySelectorAll(".quiz-change").forEach(t=>{t.disabled=!0})}async submit(t){t.preventDefault();t=await this.fetch("submit");return await this.response(t),!1}async fetch(t,e){var s,i=new FormData(this.form);for(s in i.append("action",t),i.append("offset",this.current),i.append("total",this.total||0),e)e.hasOwnProperty(s)&&i.append(s,e[s]);t=await fetch(this.url,{method:"POST",headers:{Accept:"application/json","X-Quiz-Token":this.csrf},body:i});if(t.ok)return t.json();throw new Error("Failed to fetch data from server")}async response(t){window.QuizDebug&&console.log("Response",t),t.success?(t.output.redirect&&(window.location.href=t.output.redirect),t.output.content&&(this.steps.style.display="none",this.buttons.style.display="none",this.sections.forEach((t,e)=>{(this.cover||e)&&t.remove()}),this.form.insertAdjacentHTML("beforeend",t.output.content),this.result=this.quiz.querySelector(".quiz-result"),++this.current,this.updateTotal(t.total)),t.output.step&&(this.steps.insertAdjacentHTML("beforeend",t.output.step),this.current++,this.showCurrentSection(),t.total)&&this.updateTotal(t.total),""===t.output&&""!==t.message&&alert(t.message)):(this.displayErrors(t.errors),this.updateButtons())}showCurrentSection(){this.updateSection(),this.hideSections(),this.cover&&1===this.current&&(this.cover.style.display="none",this.steps.style.display="flex",this.buttons.style.display="flex");var t=this.getCurrentSection();t&&(t.style.display="")}getCurrentSection(){return this.sections[this.current-1]}updateButtons(){this.startBtn&&(this.startBtn.disabled=!1),this.prevBtn&&(this.prevBtn.style.display=1<this.current&&this.current<=this.total?"flex":"none",this.prevBtn.disabled=!1),this.nextBtn&&(this.nextBtn.style.display=this.current>this.total?"none":"flex",this.nextBtn.disabled=!1),this.submitBtn&&(this.submitBtn.style.display=this.current>this.total?"flex":"none",this.submitBtn.disabled=!1),this.resetBtn=this.quiz.querySelector(".quiz-reset"),this.resetBtn&&(this.resetBtn.removeEventListener("click",this.reset.bind(this)),this.resetBtn.addEventListener("click",this.reset.bind(this)))}displayErrors(t){var e,s,i=this.getCurrentSection();for([e,s]of Object.entries(t)){var r=i.querySelectorAll(`[name="${e}"]`),r=(r.length?r.forEach(t=>{t.classList.add(this.classInvalid)}):alert(s),i.querySelectorAll(`[name="${e}[]"]`)),r=(r.length&&r.forEach(t=>{t.classList.add(this.classInvalid)}),i.querySelector(`.error[data-name="${e}"]`));r&&(r.classList.add("d-flex"),r.textContent=s)}}clearFormError(t){var e=this.getCurrentSection(),t=t.name.replace("[]","");e.querySelectorAll(`[name="${t}"]`).forEach(t=>{t.classList.remove(this.classValid),t.classList.remove(this.classInvalid)});e.querySelectorAll(`[name="${t}[]"]`).forEach(t=>{t.classList.remove(this.classValid),t.classList.remove(this.classInvalid)});e=e.querySelector(`.error[data-name="${t}"]`);e&&(e.classList.remove("d-flex"),e.textContent="")}reset(){this.form.reset(),this.updateSection(),this.current=this.sections.length,this.updateTotal(),this.resetBtn&&this.resetBtn.removeEventListener("click",this.reset.bind(this)),this.result&&this.result.remove(),this.cover?this.cover.style.display="":(this.steps.style.display="",this.buttons.style.display="flex",this.getCurrentSection().style.display=""),this.form.querySelectorAll("."+this.classValid+",."+this.classInvalid).forEach(t=>{t.classList.remove(this.classValid),t.classList.remove(this.classInvalid)})}}document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".quiz").forEach(t=>new Quiz(t))});